# **2/7(土)**
### 【学習時間】
4.2h(累計:1205h/1,000h)  

### 【学習内容】
- paiza
- 本リリ作業
___
### 【やったこと】
- 日本酒記録のFormObject化
  - 日本酒の記録を投稿する場合、Sakeモデル・SakeLogモデルの2つのモデルの更新が必要である。(今後、さらに関連モデルが増える)
  - SakeLogControllerでCRUD処理を行っていたが、単一責任の原則に反するため、FormObjectを作成し、責任を分解した
- 編集・削除ボタンのサイズ変更(小さったので大きくした)
- 画面の見た目の微調整  
  
### 【学んだこと】（知識・タスク分解などの振り返り）  
- FormObject化について
	- FormObjectする前は、バリデーションチェック等は、ApplicationRecordを継承しているSakeLogモデル等が行っていた
	- 一方、FormObjectは、ApplicationRecord を継承しない Plain Ruby Object（PORO）の為、バリデーションのような機能を使いたい場合は、必要なモジュールをインクルードする　必要がある。
  - インクルードしたモデル
	  - Modelモジュール
		  - 属性への代入、属性の命名、バリデーション機能などが使用可能となる
		  - 上記の機能はModelモジュールに含まれるAPIモジュールが持っている機能である(ActiveModel::Modelをインクルードすれば、そこに含まれるActiveModel::APIの機能も使用できる)
		  - [Modelモジュール Railsガイド](https://railsguides.jp/v7.2/active_model_basics.html#model%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB)
	  - データ型の定義、デフォルト値の設定機能などが使用可能となる
	  - [Attributesモジュール Railsガイド](https://railsguides.jp/v7.2/active_model_basics.html#attributes%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB)
  - コンストラクタ
	  - SakeLogForm.newでコンストラクタが呼ばれる
- form_withについて
  - ビューでform_withを呼ぶと暗示的に以下が呼ばれる
    - persisted?メソッド
	    - 対象インスタンスがDBに保存済みか否かを返す
	    - 戻り値を受けてビュー側では以下の挙動となる
		    - 未保存なら、新規作成画面となる
		    - 保存済みなら、編集画面となる
	    - ActiveModel::APIモジュールでは、persisted?メソッドがデフォルトでは `false` を返すため、編集フォームを作る場合はオーバーライドする必要がある。[Active Model API](https://api.rubyonrails.org/v7.2.3/classes/ActiveModel/API.html#method-i-persisted-3F)
    - model_nameメソッド
      - form_objectはモデル名からURLを推察する。
      - 今回は、sake_logs_pathを使用したいので、 `SakeLog.model_name` を返している
    - to_modelメソッド
      - ActiveModel::APIモジュールのデフォルトでは、 `self` を返す。(今回はそのまま)
- **`assign_attributes` メソッド**
    - 指定した値をモデルの属性に代入するメソッド
    - データベースに保存するされないため、`save`メソッドが別途必要
    - 一部の属性だけを変更し、他の属性を保持したままにできる
- rubyのメソッドの引数を渡すときに `()` を省略できる
    - redirect_toなど、メソッドの後に色々オプションを記述するコードの書き方がありますが、これはrubyのコードは引数の`()` を省略できるというルールを使って記載している。つまり、redirect_toの後に続くものは、redirect_toへの引数である。
    - redirect_to
        
        ```ruby
        # 括弧なし（よく見る）
        redirect_to sake_logs_path, notice: "保存しました"
        
        # 括弧あり
        redirect_to(sake_logs_path, notice: "保存しました")
        ```
        
    - validates
        
        ```ruby
        # 括弧なし（よく見る）
        validates :rating, presence: true, numericality: { only_integer: true }
        
        # 括弧あり
        validates(:rating, presence: true, numericality: { only_integer: true })
        ```
        
    - アソシエーション
        
        ```ruby
        # 括弧なし（よく見る）
        belongs_to :user
        has_many :sake_logs, dependent: :destroy
        
        # 括弧あり
        belongs_to(:user)
        has_many(:sake_logs, dependent: :destroy)
        ```

___

FormObject化をしたことで、Railsが裏でよしなにやってくれていたことを自分で実装する必要があり、どんな処理をしているかを知ることが出来ました。
また、実務でJavaでオブジェクト指向の実装を行っており、色々クラス設計を行った経験があったため、FormObjectのような新たなクラスを作る際に、知識をキャッチアップしやすくなったなという実感がありました。

___
FormObjectを実装するにあたり、Railsの公式ドキュメントを様々読みました。
公式ドキュメントがあるのはありがたいなと思う一方、Javaの公式ドキュメント(Java API ドキュメント)の方がユーザー数が多いからか充実しているなと感じました。(標準化されていたり、リンクが充実していたり、、、)

# **2/11(水)**
### 【学習時間】
5.13h(累計:1,216.3h/1,000h)  

### 【学習内容】
- アプリ開発

  
___
### アプリ開発
日本酒の記録アプリ。
### 【やったこと】
- 好み度の未選択・0の表示区別
    - 好み度が画面上、以下の区別が付かなかったので、表示を区別するようにした
        | 状態 | raitingの値 | 表示 |
        | --- | --- | --- |
        | 未選択 | nil | 灰色 |
        | 好み度 0 | 0 | 黄色 |
      [![Image from Gyazo](https://i.gyazo.com/eed583c305f467f22bdb2e2f2406495e.gif)](https://gyazo.com/eed583c305f467f22bdb2e2f2406495e)
       - 実現方法としてはstimulusを使用した
        - ビューファイル
            
            ```ruby
            <%# 画面左 好み度入力 %>
            <div class="rating rating-xl flex items-center gap-2",
                  data-controller="rating">
              <%# 好み度0 %>
              <%= f.radio_button :rating, SakeLog::RATING_MIN, class: "rating-hidden",
                  id: "rating-0", aria: { label: "clear" },
                   data: { action: "change->rating#select" } %>
            
              <%# 好み度1〜5　%>
              <% rating_range = (SakeLog::RATING_MIN + 1)..SakeLog::RATING_MAX %>
              <%# 初期表示の星色をrating値に応じて切り替え(nil→灰色、値あり→黄色) %>
              <% star_color = sake_log.rating.nil? ? "bg-stone-400" : "bg-yellow-300" %>
              <% rating_range.each do |i| %>
                <%= f.radio_button :rating, i, class: "mask mask-star-2 #{star_color}",
                    id: "rating-#{i}", aria: { label: "#{i} star" },
                    data: { rating_target: "star", action: "change->rating#select" } %>
              <% end %>
            </div>
            ```
            
            - `data-controller="rating”`で使用するstimulusコントローラを指定
            - `<% star_color = sake_log.rating.nil? ? "bg-stone-400" : "bg-yellow-300" %>` と`<%= f.radio_button :rating, ~~~ class: " ~~~ #{star_color}", ~~~ %>` で
                - 新規登録時：raiting=nil→星の色を灰色に
                - 編集時：raiting≠nil→星の色を黄色に
            - `<%= f.radio_button :rating, ~~~ data: { rating_target: "star" ~~~} %>`
                - `data-rating-target="star"` を各要素を(好み度1～5のラジオボタン)に付与し、各要素をstimulusで`this.starTargets` として配列で参照できるようにする
        - stimulus コントローラ
            
            ```jsx
            export default class extends Controller {
              static targets = ["star"]
            
              connect() {
                this.updateStarColors()
              }
            
              // ラジオボタンが選択された時（星クリック・クリアボタン共通）
              select() {
                this.updateStarColors()
              }
            
              //  星の色を更新する
              // - ラジオボタンが未選択（null）→ 灰色
              // - ラジオボタンが選択済み（0〜5）→ 黄色
              updateStarColors() {
                const checked = this.element.querySelector('input[type="radio"]:checked')
                const isNull = !checked
            
                this.starTargets.forEach(star => {
                  if (isNull) {
                    // ratingがnull（未選択）
                    star.classList.remove("bg-yellow-300")
                    star.classList.add("bg-stone-400")
                  } else {
                    // ratingが0〜5（選択済み）
                    star.classList.remove("bg-stone-400")
                    star.classList.add("bg-yellow-300")
                  }
                })
              }
            }
            ```
            
            - `connect()` ：`data-controller="rating"` を持つ要素がDOMに登場したときに呼ばれる
            - `select()` ：ビューファイルの好み度0～5が押された場合、ビューファイルの`data: { action: "change->rating#select" }` がトリガーとなり呼ばれる
            - `updateStarColors()`
                - `this.element` ：data-controller="rating" が付いたHTML要素そのものを指す。つまりビューファイルの以下の範囲が該当
                    
                    ```ruby
                    <div class="rating rating-xl flex items-center gap-2"
                         data-controller="rating">
                         ~~~
                    </div>
                    ```
                    
                - `.querySelector('input[type="radio"]:checked')`
                    - ラジオボタンでチェックされている要素があれば、その要素を返す
                    - 無ければ `null`
                - `this.starTargets.forEach  ~~~`
                    - ラジオボタンでチェックされてるものが無ければ→星マークに`bg-stone-400` を付与(灰色にする)
                    - ラジオボタンボタンでチェックされているものがある→星マークに`bg-yellow-300` を付与(黄色にする)
                - ※新規登録画面にアクセスするとビュー側で`<% star_color = sake_log.rating.nil? ? "bg-stone-400" : "bg-yellow-300" %>` と`<%= f.radio_button :rating, ~~~ class: " ~~~ #{star_color}", ~~~ %>` にて各要素に既に`bg-stone-400` が付与され、stimulusにて更に`star.classList.add("bg-stone-400")` を行っている(既に持っている要素を追加している)が、`classList.add()` は同じクラスを重複追加しない為、最終的には、`bg-stone-400` が一つだけ持っている要素が生成される。冪等を確保するための安全な書き方である。
- バリデーションエラー時の表示崩れ
    - Railsは、バリデーションエラー時の動作
        - Railsでは、バリデーションエラーが発生すると、その要素を`<div class="field_with_errors">` でラップする
        - これは、CSSでバリデーションエラー発生個所を目立たせたりする際に利用される想定の機能である。(以下 例)
            
            ```css
            .field_with_errors {
              padding: 2px;
              background-color: red;
              display: table;
            }
            ```
            
        - 参考: [Railsガイド Active Record バリデーション]([https://railsguides.jp/v7.2/active_record_validations.html#バリデーションエラーをビューで表示する](https://railsguides.jp/v7.2/active_record_validations.html#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%92%E3%83%93%E3%83%A5%E3%83%BC%E3%81%A7%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B))
    - 実際の例
        - 正常時
            
            [![Image from Gyazo](https://i.gyazo.com/c8629eda7bdb1fcf2d0a1da384212e04.png)](https://gyazo.com/c8629eda7bdb1fcf2d0a1da384212e04)
            
            ```ruby
            <div class="field w-full md:w-8/12">
              <label for="user_name">ユーザー名</label><br>
              <input autofocus="autofocus" autocomplete="name" class="input input-primary w-full" type="text" name="user[name]" id="user_name">
            </div>
            ```
            
        - エラー時
            
            [![Image from Gyazo](https://i.gyazo.com/d090fa90db0f7797d5d16e57bba78d4d.png)](https://gyazo.com/d090fa90db0f7797d5d16e57bba78d4d)
            
            - 各入力項目のラベルとinputエリアの間隔が広がってしまっている
            
            ```ruby
            <div class="field w-full md:w-8/12">
              <div class="field_with_errors"><label for="user_name">ユーザー名</label></div><br>
              <div class="field_with_errors"><input autofocus="autofocus" autocomplete="name" class="input input-primary w-full" type="text" value="" name="user[name]" id="user_name"></div>
            </div>
            ```
            
            - 各要素が`<div class="field_with_errors"></div>` でラップされている
    - 表示崩れの簡単な解決策→CSSに以下を追加する
        
        ```css
        .field_with_errors {
          display: contents;  /*その要素自体を、あたかも存在しないかのように扱う（ただし中身の子要素は残す）*/
        }
        ```
        
        - 結果
            
            [![Image from Gyazo](https://i.gyazo.com/4db9dc181f24e65eddd6150a812c3736.png)](https://gyazo.com/4db9dc181f24e65eddd6150a812c3736)
            
            - レイアウト崩れが抑制されている
    - 今回採用した対策
        - 私のアプリでは、DaisyUIの[Rating](https://daisyui.com/components/rating/#mask-star-2-with-warning-color)機能を利用しているが、`<div class="rating">` の子要素に`<div class="field_with_errors">` が入ってしまうと`display: contents;` をしても挙動がおかしくなる為、別手法をとった。
        - 対策の概要
            - デフォルトの挙動(`<div class="field_with_errors"></div>`でラップする)を、各要素のクラスに`field_with_errors` を追加する挙動にオーバーライド
        - コード
            
            ```ruby
            # config/initializers/field_error_proc.rb
            ActionView::Base.field_error_proc = Proc.new do |html_tag, _instance|
              doc = Nokogiri::HTML::DocumentFragment.parse(html_tag)
              doc.children.each do |node|
                if node.element?
                  existing = node['class'].to_s
                  node['class'] = "#{existing} field_with_errors".strip
                end
              end
              doc.to_html.html_safe
            end
            ```
            
            - 引数の`html_tag`
                - エラーが発生したフォーム部品のHTML文字列
                    - `"<input class=\"input input-primary w-full\" type=\"text\" value=\"\" name=\"sake_log[product_name]\" id=\"sake_log_product_name\" />”` など
            - `doc = Nokogiri::HTML::DocumentFragment.parse(html_tag)`
                - Nokogiri
                    - HTMLを安全に操作するためのライブラリ
                - `Nokogiri::HTML::DocumentFragment.parse(html_tag)`
                    - 引数`html_tag` の文字列を操作できるHTMLオブジェクトに変換している
                - Java風
                    
                    ```java
                    DocumentFragment doc = Nokogiri.parseFragment(htmlTag);
                    ```
                    
            - `doc.children.each do |node|`
                - HTMLの要素を1つずつ取り出す
            - `if node.element?`
                - コメントや改行ではなく、HTML要素かどうか確認
                - `<input>`、`<label>`、`<select>`のようなものだけを取り出している
            - `existing = node['class'].to_s`
                - 要素のclass属性を文字列として変数に格納
                - 例
                    - nodeが`<input class="input input-primary">`の場合
                    - `existing = "input input-primary”` となる
            - `"#{existing} field_with_errors".strip`
                - 既存のclass属性に  `field_with_errors` を追加
                - `.strip` で前後の余分な空白を削除
            - `node['class'] = ○○`
                - nodeのclassを設定
                - Java風:
                    
                    ```java
                    node.setAttribute(
                      "class",
                      ○○
                    );
                    ```
                    
            - `doc.to_html.html_safe`
                - DOMをHTML文字列として戻す
                - `.to_html`
                    - DOMをHTML文字列に変換
                - `.html_safe`
                    - 文字列のままRailsに返すとRailsがXSS対策で、文字列を自動エスケープしてしまう
                        - 例
                            
                            ```ruby
                            "<input>".to_s
                            ```
                            
                            は、画面に出すと
                            
                            ```ruby
                            &lt;input&gt;
                            ```
                            
                    - `.html_safe` を付けると、エスケープせずに表示してくれる
                        - `"<input>".html_safe` とすると画面に`<input>`として表示される
                - Java風
                    
                    ```java
                    return doc.toHtml();
                    ```
                    
            - 全体をJava風に書くと以下の通り
                
                ```java
                ActionViewBase.fieldErrorProc = new FieldErrorProc() {
                  @Override
                  public String call(String htmlTag, Object instance) {
                
                    DocumentFragment doc =
                        Nokogiri.parseFragment(htmlTag);
                
                    for (Node node : doc.getChildren()) {
                      if (node.isElement()) {
                
                        String existing = node.getAttribute("class");
                
                        if (existing == null) {
                          existing = "";
                        }
                
                        node.setAttribute(
                          "class",
                          (existing + " field_with_errors").trim()
                        );
                      }
                    }
                
                    return doc.toHtml();
                  }
                };
                ```
  

