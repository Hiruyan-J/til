# ** 10/6(月) **
### 【学習時間】
6.96h(累計:1023h/1,000h)
  
### 【学習内容】
- アプリ開発
  
### 【課題を通して学んだこと】
  
___
## PosiRem開発記録
[PosiRem!](https://school.runteq.jp/v3/social_portfolios/1434/web_applications/568)
### 【アプリの概要】
PosiRem! - 言葉をポジティブに変えるアプリ 秋になりお出かけも増えてくる季節になりました。 でもせっかくのお出掛けで「走らないで！」「触らないで！」 つい口から出てしまう、子供への強い言葉。 後で後悔する…そんな経験はありませんか？ PosiRem!（ポジリム）は、子供への注意言葉を優しい言葉に言い換えるお手伝いをするAIアプリです。あなたの「つい言ってしまう注意言葉」を入力するだけで、AIがポジティブな表現を3つ提案してくれます。
  
### 【やったこと】
- プロンプトの改良
	- 子供が分かりやすい例えを入れるように修正
	- 状況に応じて、子供に選択肢を渡し、子供が「自分で選んだ」ことで、自主的に行動できるように修正
- ユーザーの入力がcontrollerに渡っていなかったので改修
- Active JobでAIの変換作業をバックグラウンド処理に修正
- Turbo Streamで非同期で画面を描画
- AIのレスポンスが返ってきた後、Action CableのWebsocketで非同期で画面に表示されるように改修
- Action Cable のバックエンドを Solid Cable に置き換え
- Xシェア機能の実装
  
### 【学んだこと】（知識・タスク分解などの振り返り） 
- AIのレスポンスを非同期処理
  - AIのレスポンスに時間がかかるので、非同期処理を導入しました。
  - 流れとしては以下の通りです。
    - ユーザーがテキストを送信する(HTTPのpostリクエスト)
    - createアクションが走る
	    - バックグラウンド処理を走らせる(Active Job)
	    - Turbo Streamで画面の必要な個所だけ更新(今回は、テキストボックスクリア、投稿した内容のチャットバブルを表示、「AIが考え中です」の表示)
    - バックグラウンド処理
	    - AIにプロンプトを投げる
	    - 帰って来たらJsonをパースしてDBに保存
	    - Websocketで画面の更新内容(Turbo Stream)を配信(今回は、「考え中」の削除、AIの回答のチャットバブルの表示)
  
[![Image from Gyazo](https://i.gyazo.com/1e51997390d07fb2a09a8b9bab0c0270.gif)](https://gyazo.com/1e51997390d07fb2a09a8b9bab0c0270)
  
### 【今後の予定】
- 自動スクロール機能の実装
- 静的OGP画像


# ** 10/7(火) **
### 【学習時間】
5h(累計:1,029h/1,000h)
  
### 【学習内容】
- ミニアプリ開発
___
## PosiRem開発記録
[PosiRem!](https://school.runteq.jp/v3/social_portfolios/1434/web_applications/568)
### 【アプリの概要】
PosiRem! - 言葉をポジティブに変えるアプリ 秋になりお出かけも増えてくる季節になりました。 でもせっかくのお出掛けで「走らないで！」「触らないで！」 つい口から出てしまう、子供への強い言葉。 後で後悔する…そんな経験はありませんか？ PosiRem!（ポジリム）は、子供への注意言葉を優しい言葉に言い換えるお手伝いをするAIアプリです。あなたの「つい言ってしまう注意言葉」を入力するだけで、AIがポジティブな表現を3つ提案してくれます。
  
### 【やったこと】
- Xへのシェアボタンで生成されるポストのURLが`https://example.org/`となってしまう不具合対応
- 静的OGP画像の設定
- 静的OGP画像が表示されない不具合対応
- AIへのプロンプトの微修正  

### 【学んだこと】（知識・タスク分解などの振り返り） 
- **Xへのシェアボタンで生成されるポストのURLが`https://example.org/`となってしまう不具合対応**
	- 事象	    
	    - 以下のコードでXへのシェアボタンを生成している	    
	    ```ruby
	          <% x_share_url = "https://twitter.com/intent/tweet?url=#{root_url}&text=#{ERB::Util.url_encode(share_text)}" %>
	          <%= link_to x_share_url, target: "_blank", rel: "noreferrer", class: "btn btn-xs btn-natural btn-square text-secondary-content", data: { toggle: "tooltip", placement: "auto" }, title: "Xでシェア" do  %>
	            <img src="/x-logo.svg" alt="Xでシェア" class="w-3 h-3 invert"/>
	          <% end %>
	    ```	    
	    - 本コードで生成されたX上のポストが、ユーザーによっては、以下のようになってしまうことが発覚	    
		    - 正しいパターン：`share_text`+ 「[https://posirem.onrender.com/」](https://posirem.onrender.com/%E3%80%8D)
		    - 不具合パターン：`share_text`+「[**https://example.org/**」](https://example.org/%E3%80%8D)	    
	- 対策案	    
	    - Renderのデフォルトの環境変数**`RENDER_EXTERNAL_HOSTNAME`** を取得し、config/environments/production.rbでhostを設定する	    
	    - 参考：https://render.com/docs/environment-variables#render-external-hostname-11:~:text=RENDER_EXTERNAL_HOSTNAME    
	- 事前調査
	    - 環境変数**`RENDER_EXTERNAL_HOSTNAME`**が取得可能かを確認
	        - .html.erbに以下のコードを記載	            
	            ```ruby
	                <div style="display: none;">
	                  <p>root_url: <%= root_url %></p>
	                  <p>request.base_url: <%= request.base_url %></p>
	                  <p>request.host: <%= request.host %></p>
	                  <%# 本番環境での検証コード(開発環境でのエラーを防ぐためデフォルト値を設定) %>
	                  <% rehost = ENV.fetch('RENDER_EXTERNAL_HOSTNAME', 'Not available') %>
	                  <p>rehost: <%= rehost %></p>
	                  <%# 本番環境での検証コード(開発環境でのエラーを防ぐためデフォルト値を設定) %>
	                  <% reurl = ENV.fetch('RENDER_EXTERNAL_URL', 'Not available') %>
	                  <p>reurl: <%= reurl %></p>
	                </div>
	            ```	            
	        - 本番環境での結果	            
	            ```ruby
	            <div style="display: none;">
	              <p>root_url: https://posirem.onrender.com/</p>
	              <p>request.base_url: https://posirem.onrender.com</p>
	              <p>request.host: posirem.onrender.com</p>
	              <p>rehost: posirem.onrender.com</p>
	              <p>reurl: https://posirem.onrender.com</p>
	            </div>
	            ```	            
	            - 取得成功
	- 対策
	    - 環境設定を行う
	    - config/environments/production.rb	        
	        ```ruby
	        Rails.application.configure do
	          #... 他の設定...	        
	          # Render環境変数からホスト名を取得（設定がない場合は起動時にエラーとする）
	          host = ENV.fetch('RENDER_EXTERNAL_HOSTNAME')
	          # Action Controller および Action Mailer の default_url_options を設定
	          config.action_controller.default_url_options = { host: host, protocol: 'https' }
	          config.action_mailer.default_url_options = { host: host, protocol: 'https' }
	          # グローバルなルーティングヘルパーのデフォルトにも反映
	          Rails.application.routes.default_url_options.merge!(
	            config.action_controller.default_url_options
	          )
	          #... 
	        end
	        ```	        
	        - root_urlとの関係  

| 設定項目 | 影響するコンテキスト | `root_url`への関与 | 備考 | 
| --- | --- | --- | --- | 
| **リクエストオブジェクト** (`request.host`など) | コントローラ/ビュー（リクエスト処理中） | **最優先の決定要因**。これが失敗するとフォールバックが発生。 | 今回はこれが失敗したので、フォールバックとして**`Rails.application.routes.default_url_options`** を見に行こうとした | 
| **`Rails.application.routes.default_url_options`** | グローバルルーティングヘルパー (`root_url`)、Active Job、コンソール | **動的取得失敗時の直接的なフォールバック先** 。    | フォールバックで本設定を観ようとしたが、設定されていなかったので、`root_url`が`https://example.org/` となってしまった。 | 
| **`config.action_controller.default_url_options`** | コントローラでの`url_for`、リダイレクト | 間接的。ルーティング設定にマージすることで影響を与える 。    |  | 
| **`config.action_mailer.default_url_options`** | Action Mailer、Active Job（メール送信） | 間接的。非リクエストコンテキストでの URL を保証する 。 |  | 
  
- **静的OGP画像が表示されない不具合対応**
  - OGPが正しくされなかったので調査した
  - 以下のサイトにURLを入力することで、そのページのOGP設定の確認ができる
	  - https://rakko.tools/tools/9/
		  - 画像の読み込みができることを確認できた→OGP画像自体は正しく設定できている
  - [Card validator](https://cards-dev.twitter.com/validator)というツールで、強制クロール
	  - 以下のエラーが発生
		  ```
		  ERROR: The 'summary_image' card type provided by the twitter:card metatag is not a valid card type. Valid card types are 'app', 'player', 'summary' and 'summary_large_image'. (Card error)
		  ```
	  - エラーに従い twitter:card メタタグに設定していた`summary_image`を`summar`に修正
  - 無事にOGP画像が表示されることを確認できた  

### 【今後の予定】
- 自動スクロール機能の搭載


