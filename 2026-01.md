# **01/03(土)**
### 【学習時間】
5h(累計:1159h/1,000h)  

### 【学習内容】
- Stimulusのキャッチアップ
  
### 【学んだこと】（知識・タスク分解などの振り返り）  
- [Stimulus ハンドブック](https://stimulus.hotwired.dev/handbook/introduction)でStimulusのキャッチアップ
## [Hello, Stimulus](https://stimulus.hotwired.dev/handbook/hello-stimulus)
- html
    - `data-controller`, `data-clipboard-target`, `data-action`を設定する
- コントローラー
    - ○○_controller.jsファイルを作成する
    - default classにメソッドや変数を設定

## [Building Something Real](https://stimulus.hotwired.dev/handbook/building-something-real)
- static targetsについて    
    Stimulus がコントローラークラスを読み込む際、`targets` という静的配列内のターゲット名文字列を探します。配列内の各ターゲット名に対して、Stimulus はコントローラーに3つの新しいプロパティを追加します。ここでは、`"source"` というターゲット名が以下のプロパティに変換されます：    
    - `this.sourceTarget` は、コントローラーのスコープ内で最初に現れる `source` ターゲットを参照します。もし `source` ターゲットが存在しない場合、このプロパティにアクセスするとエラーが発生します。
    - `this.sourceTargets` は、コントローラーのスコープ内に存在するすべての `source` ターゲットの配列を返します。
    - `this.hasSourceTarget` は、`source` ターゲットが存在する場合は `true` を、存在しない場合は `false` を返します。    
    ターゲットに関する詳細な情報は、[**リファレンスドキュメント**](https://stimulus.hotwired.dev/reference/targets)で確認できます。
    
- HTMLの各要素に対してデフォルトで設定されているイベント    
    以下の要素に対しては、アクション記述子に監視するイベントを定義(`click->`など)しなくても次のイベントでStimulusが実行される   
    | 要素 | デフォルトイベント |
    | --- | --- |
    | a | クリック |
    | ボタン | クリック |
    | 詳細 | トグル |
    | form | submit |
    | input | input |
    | 入力タイプ=submit | クリック |
    | select | 変更 |
    | textarea | input |
- `navigator.clipboard.writeText(text)`
    - `navigator`
        - ブラウザが提供するグローバルオブジェクト 。ブラウザやユーザー環境に関する機能をまとめている。
        - JavaScriptでどこからでも使用可能
    - `navigator.clipboard`
        - Clipboard API
        - コピー／ペーストの操作を JavaScript から行うための API
    - `navigator.clipboard.writeText(text)`
        - 指定した文字列をクリップボードにコピーする
    - writeTextはPromise を返す
        - 成功したら resolve
        - 失敗したら reject
- Stimulusコントローラーの再利用    
    Stimulusコントローラーは再利用可能である。    
    1つのページ上に `data-contrller=”clipboard”` が複数あっても、 `clipboard_controller.js`は1つでOK。    
- `event.preventDefault()` でその要素のデフォルトの動作をキャンセルできる
    - 例: リンクをクリックしたとき、リンク先に移動する動作をキャンセルし、Stimulusの動作だけを実行するなど

## [レジリエンスを考慮した設計](https://stimulus.hotwired.dev/handbook/designing-for-resilience)
- **`this**.element.classList.**add**(string)`
    - クラスを追加する

## [状態管理](https://stimulus.hotwired.dev/handbook/managing-state)
- ライフサイクルコールバック
    - initialize()やconnect()メソッド 

| メソッド | Stimulusによって呼び出されるタイミング |
| --- | --- |
| initialize() | コントローラーが最初にインスタンス化された時、一度だけ実行されます |
| connect() | コントローラーが DOM に接続されるたびに |
| disconnect() | コントローラーが DOM から切断されるたびに |

- 変更時コールバック
    - `○○ValueChanged()` : 初期化時および○○Value(data-slideshow-○○-value)の値が変更される度に実行される。呼び出しタイミングは、initialize()後または○○Valueの値を変更するメソッドの処理が終了した後。
- コントローラ側でのデフォルト値の設定
    - default: でHTMLのコントローラ要素で任意の値属性が定義されていない場合に使用するデフォルト値を設定することが出来る。    
    ```jsx
     static values = { index: Number, effect: { type: String, default: "kenburns" } }
    ```
    

## [外部リソースとの連携](https://stimulus.hotwired.dev/handbook/working-with-external-resources)
- HTMLの非同期読み込み    
    ```jsx
    // src/controllers/content_loader_controller.js
    import { Controller } from "@hotwired/stimulus"
    
    export default class extends Controller {
      static values = { url: String }
    
      connect() {
        this.load()
      }
    
      load() {
        fetch(this.urlValue)
          .then(response => response.text())
          .then(html => this.element.innerHTML = html)
      }
    }
    ```
    
    - loadメソッド解説        
        ```jsx
        fetch(this.urlValue)
          .then(response => response.text())
          .then(html => this.element.innerHTML = html)
        ```
        
        1. `fetch()` 実行 → Promise を返す
        2. 通信開始（裏で進む）
        3. 通信が成功 → Promise が fulfilled
        4. **1つ目の `.then` 実行**
        5. `response.text()` 実行 → Promise を返す
            - responseの内容(抜粋)
                
                ```jsx
                Response {type: 'basic', url: 'http://localhost:9000/messages.html', redirected: false, status: 200, ok: true, …}
                body: ReadableStream
                	locked: true
                	[[Prototype]]: ReadableStream
                	bodyUsed: true
                headers: Headers
                	[[Prototype]]: Headers
                	ok: true
                	redirected: false
                	status: 200
                	statusText: "OK"
                	type: "basic"
                	url: "http://localhost:9000/messages.html"
                [[Prototype]]: Response
                ```
                
                - 本文(body)は、ReadableStream(少しずつ流れてくるデータ)のため、全部そろっていない可能性がある。
            - response.text()
                - `response.body`（ReadableStream）を
                - **最後まで読み切る**
                - バイト列を **文字列に変換**
                - その文字列を **Promise として返す**
            - 本文を取得するメソッド
        6. 本文の読み取り完了
        7. **2つ目の `.then` 実行**
- 本文を取り出すメソッド

| メソッド | 何を返すか | やりたいこと |
| ---- | ---- | ---- |
| `response.text()` | 文字列 | HTMLを差し込む |
| `response.json()` | JSON をパースしたオブジェクト | JSONを扱う |
| `response.blob()` | Blob（バイナリ） | 画像・PDF表示 |
| `response.arrayBuffer()` | ArrayBuffer | バイナリ解析 |

- タイマーによる自動更新機能
    - コントローラ
        
        ```jsx
        export default class extends Controller {
          static values = { url: String, refreshInterval: Number }
        
          startRefreshing() {
            setInterval(() => {
              this.load()
            }, this.refreshIntervalValue)
          }
        
          // …
          load() {
            // …
          }
        }
        ```
        
    - `setInterval(あとで実行する関数, 時間)`メソッド:一定の間隔を置いて関数やコードスニペットを繰り返し呼び出す。
        - https://developer.mozilla.org/ja/docs/Web/API/Window/setInterval
        - 引数の`あとで実行する関数` に同じcontroller内のメソッドを渡したい場合は、アロー関数と this 表記と組み合わせて記載すること
            - 今回は、`() => {  this.load()  }` の部分が該当
        - 返り値は、**インターバルID**(正の整数)を返す
- 追跡リソース解放
    - `clearInterval(intervalID)` ※ https://developer.mozilla.org/ja/docs/Web/API/Window/clearInterval
        - 引数
            - [`intervalID`](https://developer.mozilla.org/ja/docs/Web/API/Window/clearInterval#intervalid)
                - 取り消したい繰り返し動作の識別子です。
                - この ID は対応する `setInterval()` の呼び出しの返値です。
- アクションパラメータ
    - **`<a href="#" data-content-loader-url-param="/messages.html" data-action="content-loader#load">**Messages**</a>**`
    - コントローラ側で以下で取り出せる
        - `load(event)` → `event.params.url`
        - `load({ params })` → `params.url`
        - `load( { params: { url } })`
    - eventの中身
        
        ```jsx
        PointerEvent {isTrusted: true, immediatePropagationStopped: false, params: {…}, pointerId: 1, stopImmediatePropagation: ƒ, …}
        immediatePropagationStopped: false
        isTrusted: true
        params: 
        	url: "/messages.html"
        	[[Prototype]]: Object
        stopImmediatePropagation: ƒ stopImmediatePropagation()
        altKey: false
        altitudeAngle: 1.5707963267948966
        azimuthAngle: 0
        bubbles: true
        button: 0
        buttons: 0
        cancelBubble: false
        cancelable: true
        clientX: 52
        clientY: 297
        composed: true
        ctrlKey: false
        currentTarget: null
        defaultPrevented: true
        detail: 1
        eventPhase: 0
        fromElement: null
        height: 1
        isPrimary: false
        layerX: 52
        layerY: 297
        metaKey: false
        movementX: 0
        movementY: 0
        offsetX: 44
        offsetY: 6
        pageX: 52
        pageY:297
        persistentDeviceId:0
        pointerId:1
        pointerType:"mouse"
        pressure:0
        relatedTarget:null
        returnValue: false
        screenX: 74
        screenY: 388
        shiftKey: false
        sourceCapabilities: InputDeviceCapabilities {firesTouchEvents: false}
        srcElement: a
        tangentialPressure: 0
        target: a
        tiltX: 0
        tiltY: 0
        timeStamp: 6046
        toElement: null
        twist: 0
        type: "click"
        view: Window {window: Window, self: Window, document: document, name: '', location: Location, …}
        which: 1
        width: 1
        x: 52
        y: 297
        [[Prototype]]: PointerEvent
        ```

