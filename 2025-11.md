# **11/9(日)**
### 【学習時間】
5h(累計:1,092h/1,000h)  

### 【学習内容】
- 開発作業

___
## 卒制記録
https://github.com/Hiruyan-J/GinLog
### 【やったこと】
- DBをNeonに変更
- ローカル環境のPostgreSQLのバージョン変更
  
### 【今後の予定】
- ファビコンの設定

___
**エラー対応**
- 事象
    
    `docker compse up` 時に以下のエラーが発生
    
    ```bash
    db-1   | 2025-11-09 18:05:23.737 JST [367] WARNING:  database "myapp_development" has a collation version mismatch
    db-1   | 2025-11-09 18:05:23.737 JST [367] DETAIL:  The database was created using collation version 2.36, but the operating system provides version 2.41.
    db-1   | 2025-11-09 18:05:23.737 JST [367] HINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE myapp_development REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.
    db-1   | 2025-11-09 18:05:39.384 JST [376] WARNING:  database "template1" has a collation version mismatch
    db-1   | 2025-11-09 18:05:39.384 JST [376] DETAIL:  The database was created using collation version 2.36, but the operating system provides version 2.41.
    db-1   | 2025-11-09 18:05:39.384 JST [376] HINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE template1 REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.
    db-1   | 2025-11-09 18:05:53.735 JST [393] WARNING:  database "myapp_test" has a collation version mismatch
    db-1   | 2025-11-09 18:05:53.735 JST [393] DETAIL:  The database was created using collation version 2.36, but the operating system provides version 2.41.
    db-1   | 2025-11-09 18:05:53.735 JST [393] HINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE myapp_test REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.
    db-1   | 2025-11-09 18:08:09.658 JST [499] WARNING:  database "postgres" has a collation version mismatch
    db-1   | 2025-11-09 18:08:09.658 JST [499] DETAIL:  The database was created using collation version 2.36, but the operating system provides version 2.41.
    db-1   | 2025-11-09 18:08:09.658 JST [499] HINT:  Rebuild all objects in this database that use the default collation and run ALTER DATABASE postgres REFRESH COLLATION VERSION, or build PostgreSQL with the right library version.
    ```
    
- 原因
    
    Ubuntuにて、ロケールライブラリをバージョンアップしてしまった？
    
    - データベース作成時点では OS のロケールライブラリ（glibc）のバージョンが **2.36** だった
    - 現在コンテナ内の OS（Debian / Ubuntu ベースなど）の glibc が **2.41** に更新された
    - PostgreSQL は文字列ソート順（collation）が変わる可能性を検出し、「ミスマッチ」と警告を出している
- 実施した対策
    - `docker compose exec db bash` でdbコンテナのbashに入る
    - `psql -U postgres`
    - 以下をそれぞれ実施し、collation バージョンを更新
        
        ```sql
        -- デフォルト管理用データベース
        ALTER DATABASE postgres REFRESH COLLATION VERSION;
        
        -- 開発DB
        ALTER DATABASE myapp_development REFRESH COLLATION VERSION;
        
        -- テストDB
        ALTER DATABASE myapp_test REFRESH COLLATION VERSION;
        
        -- 必要なら template1 も
        ALTER DATABASE template1 REFRESH COLLATION VERSION;
        ```
        
    - INDEXの再構築
        - `REINDEX DATABASE postgres;`
        - 各DBにアクセスして、INDEXの再構築をする
            - `\c myapp_development;`
            - `REINDEX DATABASE myapp_development;`
            - 以下同様
- 参考
    
    https://zenn.dev/ciffelia/articles/postgres-collation-version-mismatch